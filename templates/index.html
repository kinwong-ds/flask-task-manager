{% extends "base.html" %}

{% block content %}
<div class="grid grid-2" style="margin-bottom: 2rem;">
    <button class="btn btn-primary" onclick="openModal('projectModal')">
        <i class="fas fa-plus"></i> New Project
    </button>
    <button class="btn btn-success" onclick="openModal('taskModal')">
        <i class="fas fa-plus"></i> New Task
    </button>
</div>

<!-- Projects Overview -->
<div class="card">
    <div class="card-header">
        <i class="fas fa-folder"></i> Projects
    </div>
    <div class="card-body">
        <div class="grid grid-3" id="projectsList">
            {% for project in projects %}
            <div class="project-card" style="border-color: {{ project.color }}; background-color: {{ project.color }}10;">
                <div class="project-card-header">
                    <div>
                        <h3 class="project-name" style="color: {{ project.color }};">{{ project.name }}</h3>
                        <p class="task-count">{{ project.tasks|length }} tasks</p>
                    </div>
                    <button class="btn btn-danger btn-sm" onclick="deleteProject({{ project.id }})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Tasks Sections -->
<div class="grid grid-3">
    <!-- Overdue Tasks -->
    <div class="card">
        <div class="card-header" style="color: #e74c3c;">
            <i class="fas fa-exclamation-triangle"></i> Overdue ({{ overdue_tasks|length }})
        </div>
        <div class="card-body">
            <div id="overdueTasks">
                {% for task in overdue_tasks %}
                <div class="task-item" data-task-id="{{ task.id }}" style="border-left-color: {{ task.project.color }};">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="flex: 1;">
                            <h4 style="margin-bottom: 0.5rem; color: #2c3e50;">{{ task.title }}</h4>
                            <p style="color: #7f8c8d; font-size: 0.9rem; margin-bottom: 0.5rem;">{{ task.project.name }}</p>
                            <div style="display: flex; align-items: center; gap: 1rem; font-size: 0.8rem;">
                                <span class="priority-{{ task.priority }}">{{ task.priority.upper() }}</span>
                                <span style="color: #e74c3c;"><i class="fas fa-calendar"></i> {{ task.due_date.strftime('%m/%d') }}</span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-success btn-sm" onclick="toggleTask({{ task.id }})">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteTask({{ task.id }})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% if not overdue_tasks %}
                <p style="text-align: center; color: #95a5a6; padding: 2rem;">No overdue tasks</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Upcoming Tasks -->
    <div class="card">
        <div class="card-header" style="color: #3498db;">
            <i class="fas fa-clock"></i> Upcoming ({{ upcoming_tasks|length }})
        </div>
        <div class="card-body">
            <div id="upcomingTasks">
                {% for task in upcoming_tasks %}
                <div class="task-item" data-task-id="{{ task.id }}" style="border-left-color: {{ task.project.color }};">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="flex: 1;">
                            <h4 style="margin-bottom: 0.5rem; color: #2c3e50;">{{ task.title }}</h4>
                            <p style="color: #7f8c8d; font-size: 0.9rem; margin-bottom: 0.5rem;">{{ task.project.name }}</p>
                            <div style="display: flex; align-items: center; gap: 1rem; font-size: 0.8rem;">
                                <span class="priority-{{ task.priority }}">{{ task.priority.upper() }}</span>
                                <span style="color: #3498db;"><i class="fas fa-calendar"></i> {{ task.due_date.strftime('%m/%d') }}</span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-success btn-sm" onclick="toggleTask({{ task.id }})">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteTask({{ task.id }})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% if not upcoming_tasks %}
                <p style="text-align: center; color: #95a5a6; padding: 2rem;">No upcoming tasks</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Completed Tasks -->
    <div class="card">
        <div class="card-header" style="color: #2ecc71;">
            <i class="fas fa-check-circle"></i> Completed ({{ completed_tasks|length }})
        </div>
        <div class="card-body">
            <div id="completedTasks">
                {% for task in completed_tasks %}
                <div class="task-item task-completed" data-task-id="{{ task.id }}" style="border-left-color: {{ task.project.color }};">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="flex: 1;">
                            <h4 style="margin-bottom: 0.5rem; color: #2c3e50;">{{ task.title }}</h4>
                            <p style="color: #7f8c8d; font-size: 0.9rem; margin-bottom: 0.5rem;">{{ task.project.name }}</p>
                            <div style="display: flex; align-items: center; gap: 1rem; font-size: 0.8rem;">
                                <span class="priority-{{ task.priority }}">{{ task.priority.upper() }}</span>
                                <span style="color: #2ecc71;"><i class="fas fa-check"></i> Completed</span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-primary btn-sm" onclick="toggleTask({{ task.id }})">
                                <i class="fas fa-undo"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteTask({{ task.id }})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% if not completed_tasks %}
                <p style="text-align: center; color: #95a5a6; padding: 2rem;">No completed tasks</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Project Modal -->
<div id="projectModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('projectModal')">&times;</span>
        <h2 style="margin-bottom: 1.5rem;">New Project</h2>
        <form id="projectForm">
            <div class="form-group">
                <label for="projectName">Project Name</label>
                <input type="text" id="projectName" name="name" required>
            </div>
            <div class="form-group">
                <label for="projectDescription">Description</label>
                <textarea id="projectDescription" name="description" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label for="projectColor">Color</label>
                <input type="color" id="projectColor" name="color" value="#3498db">
            </div>
            <button type="submit" class="btn btn-primary">Create Project</button>
        </form>
    </div>
</div>

<!-- Task Modal -->
<div id="taskModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('taskModal')">&times;</span>
        <h2 style="margin-bottom: 1.5rem;">New Task</h2>
        <form id="taskForm">
            <div class="form-group">
                <label for="taskTitle">Task Title</label>
                <input type="text" id="taskTitle" name="title" required>
            </div>
            <div class="form-group">
                <label for="taskDescription">Description</label>
                <textarea id="taskDescription" name="description" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label for="taskProject">Project</label>
                <select id="taskProject" name="project_id" required>
                    {% for project in projects %}
                    <option value="{{ project.id }}">{{ project.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label for="taskStartDate">Start Date</label>
                    <input type="date" id="taskStartDate" name="start_date" value="{{ date.today() }}">
                </div>
                <div class="form-group">
                    <label for="taskDueDate">Due Date</label>
                    <input type="date" id="taskDueDate" name="due_date">
                </div>
                <div class="form-group">
                    <label for="taskPriority">Priority</label>
                    <select id="taskPriority" name="priority">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
            </div>
            <button type="submit" class="btn btn-success">Create Task</button>
        </form>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Project form submission
    document.getElementById('projectForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        
        try {
            const result = await apiCall('/api/projects', {
                method: 'POST',
                body: JSON.stringify(data)
            });
            
            showNotification('Project created successfully!');
            closeModal('projectModal');
            location.reload();
        } catch (error) {
            showNotification('Error creating project', 'error');
        }
    });
    
    // Task form submission
    document.getElementById('taskForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        
        try {
            const result = await apiCall('/api/tasks', {
                method: 'POST',
                body: JSON.stringify(data)
            });
            
            showNotification('Task created successfully!');
            closeModal('taskModal');
            location.reload();
        } catch (error) {
            showNotification('Error creating task', 'error');
        }
    });
    
    // Toggle task completion
    async function toggleTask(taskId) {
        try {
            const result = await apiCall(`/api/tasks/${taskId}/toggle`, {
                method: 'POST'
            });
            
            showNotification('Task updated successfully!');
            location.reload();
        } catch (error) {
            showNotification('Error updating task', 'error');
        }
    }
    
    // Delete task
    async function deleteTask(taskId) {
        if (confirm('Are you sure you want to delete this task?')) {
            try {
                await apiCall(`/api/tasks/${taskId}`, {
                    method: 'DELETE'
                });
                
                showNotification('Task deleted successfully!');
                location.reload();
            } catch (error) {
                showNotification('Error deleting task', 'error');
            }
        }
    }
    
    // Delete project
    async function deleteProject(projectId) {
        if (confirm('Are you sure you want to delete this project? All associated tasks will be deleted.')) {
            try {
                await apiCall(`/api/projects/${projectId}`, {
                    method: 'DELETE'
                });
                
                showNotification('Project deleted successfully!');
                location.reload();
            } catch (error) {
                showNotification('Error deleting project', 'error');
            }
        }
    }
    
    // Set today's date as default for start date
    document.getElementById('taskStartDate').value = new Date().toISOString().split('T')[0];

    // Set dynamic colors for project cards and task items
    document.querySelectorAll('.project-card').forEach(card => {
        const color = card.getAttribute('data-project-color');
        card.style.borderColor = color;
        card.style.backgroundColor = `${color}10`;
    });

    document.querySelectorAll('.task-item').forEach(item => {
        const color = item.getAttribute('data-task-color');
        item.style.borderLeftColor = color;
    });

    document.querySelectorAll('.project-name').forEach(name => {
        const color = name.closest('.project-card').getAttribute('data-project-color');
        name.style.color = color;
    });
</script>
{% endblock %}